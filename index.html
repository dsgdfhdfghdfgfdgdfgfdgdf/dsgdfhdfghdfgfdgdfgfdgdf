<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/highlight.min.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
    <style>
        :root {
            --primary-color: #6e56cf;
            --secondary-color: #f0f0f0;
            --border-color: #e0e0e0;
            --text-color: #333;
            --light-text: #666;
            --user-msg-bg: #f1f5f9;
            --ai-msg-bg: #ffffff;
            --hover-color: #f5f5f5;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --info-color: #3498db;
            --code-bg: #f6f8fa;
            --inline-code-bg: #f1f1f1;
            --blockquote-border: #dfe2e5;
            --table-border: #dfe2e5;
            --sidebar-bg: #f8f9fa;
            --active-chat-bg: rgba(110, 86, 207, 0.1);
            --status-sending: #3498db;
            --status-waiting: #f39c12;
            --status-thinking: #2ecc71;
            --status-error: #e74c3c;
            --debug-bg: #f8f9fa;
            --debug-border: #ddd;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            display: flex;
            height: 100vh;
            background-color: #fafafa;
            overflow: hidden;
        }
        
        /* –ß–∞—Ç—ã –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .chats-sidebar {
            width: 250px;
            height: 100vh;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }
        
        .chats-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: white;
        }
        
        .chats-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .new-chat-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .new-chat-btn:hover {
            opacity: 0.9;
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-item:hover {
            background-color: #f1f3f5;
        }
        
        .chat-item.active {
            background-color: var(--active-chat-bg);
            border-left: 3px solid var(--primary-color);
        }
        
        .chat-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .chat-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chat-item:hover .chat-actions {
            opacity: 1;
        }
        
        .chat-action-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--light-text);
            padding: 2px;
        }
        
        .chat-action-btn:hover {
            color: var(--primary-color);
        }
        
        .resize-handle {
            position: absolute;
            top: 0;
            right: -5px;
            width: 10px;
            height: 100%;
            cursor: col-resize;
            z-index: 200;
        }
        
        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: white;
        }
        
        .title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .auto-scroll-container {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        
        .auto-scroll-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .auto-scroll-label input {
            margin-right: 5px;
        }
        
        .settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .settings-btn:hover {
            background-color: var(--hover-color);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 8px;
            position: relative;
        }
        
        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ */
        .message.in-context {
            border-left: 3px solid var(--primary-color);
            box-shadow: 0 0 0 1px rgba(110, 86, 207, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* –°—Ç–∞—Ç—É—Å –º–µ—Ç–∫–∞ */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 6px;
            position: relative;
        }
        
        .status-indicator.sending {
            background-color: var(--status-sending);
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.waiting {
            background-color: var(--status-waiting);
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.thinking {
            background-color: var(--status-thinking);
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.error {
            background-color: var(--status-error);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(var(--status-waiting-rgb, 243, 156, 18), 0.4);
            }
            70% {
                box-shadow: 0 0 0 5px rgba(var(--status-waiting-rgb, 243, 156, 18), 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(var(--status-waiting-rgb, 243, 156, 18), 0);
            }
        }
        
        .status-text {
            font-size: 0.75rem;
            font-style: italic;
            color: var(--light-text);
            margin-left: 5px;
        }
        
        .message-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-text);
            padding: 2px;
            font-size: 0.9rem;
        }
        
        .action-btn:hover {
            color: var(--primary-color);
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        /* Inline edit mode */
        .message-edit-container {
            width: 100%;
            margin: 5px 0;
        }
        
        .message-edit-textarea {
            width: 100%;
            min-height: 100px;
            padding: 8px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .message-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        
        .message-edit-save,
        .message-edit-cancel {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .message-edit-save {
            background-color: var(--primary-color);
            color: white;
        }
        
        .message-edit-save:hover {
            opacity: 0.9;
        }
        
        .message-edit-cancel {
            background-color: var(--secondary-color);
        }
        
        .message-edit-cancel:hover {
            background-color: var(--border-color);
        }
        
        /* Markdown styles */
        .message-content p {
            margin: 0.75em 0;
        }
        
        .message-content img {
            max-width: 100%;
            border-radius: 4px;
        }
        
        .message-content h1, 
        .message-content h2, 
        .message-content h3, 
        .message-content h4, 
        .message-content h5, 
        .message-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .message-content h1 {
            font-size: 1.75em;
        }
        
        .message-content h2 {
            font-size: 1.5em;
        }
        
        .message-content h3 {
            font-size: 1.25em;
        }
        
        .message-content h4 {
            font-size: 1em;
        }
        
        .message-content ul, 
        .message-content ol {
            padding-left: 2em;
            margin: 0.75em 0;
        }
        
        .message-content li {
            margin: 0.375em 0;
        }
        
        .message-content blockquote {
            border-left: 3px solid var(--blockquote-border);
            margin: 0.75em 0;
            padding: 0 0 0 1em;
            color: var(--light-text);
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .message-content th, 
        .message-content td {
            border: 1px solid var(--table-border);
            padding: 0.375em 0.75em;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        .message-content pre {
            position: relative;
            background-color: var(--code-bg);
            border-radius: 6px;
            padding: 1em;
            margin: 0.75em 0;
            overflow: auto;
        }
        
        .message-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }
        
        .message-content p > code {
            background-color: var(--inline-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .copy-code-btn {
            position: absolute;
            top: 7px;
            right: 7px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        pre:hover .copy-code-btn {
            opacity: 1;
        }
        
        .copy-code-btn:hover {
            background-color: white;
        }
        
        .user-message {
            background-color: var(--user-msg-bg);
            align-self: flex-end;
        }
        
        .bot-message {
            background-color: var(--ai-msg-bg);
            align-self: flex-start;
            border: 1px solid var(--border-color);
        }
        
        .char-count {
            font-size: 0.8rem;
            color: var(--light-text);
            margin-top: 5px;
            text-align: right;
        }
        
        .input-container {
            padding: 15px;
            background-color: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .context-limit {
            width: 60px;
            text-align: center;
            padding: 10px 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-right: 2px;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .message-input {
            width: 100%;
            min-height: 56px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .send-btn, .stop-btn, .regenerate-btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 56px;
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .send-btn:hover {
            opacity: 0.9;
        }
        
        .stop-btn, .regenerate-btn {
            background-color: var(--secondary-color);
        }
        
        .stop-btn:hover, .regenerate-btn:hover {
            background-color: var(--border-color);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }
        
        .save-settings-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-settings-btn:hover {
            opacity: 0.9;
        }
        
        /* –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            height: 300px;
            background-color: var(--debug-bg);
            border: 1px solid var(--debug-border);
            border-radius: 8px 0 0 0;
            z-index: 1000;
            display: none;
            flex-direction: column;
            box-shadow: -2px -2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .debug-header {
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 0 0 0;
        }
        
        .debug-title {
            font-weight: 600;
        }
        
        .debug-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .debug-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #1e1e1e;
            color: #ddd;
        }
        
        .debug-info {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        
        .debug-label {
            color: #88ccff;
            margin-right: 5px;
        }
        
        .debug-value {
            word-break: break-word;
        }
        
        .debug-value.error {
            color: #ff8888;
        }
        
        .debug-raw {
            margin-top: 10px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            background-color: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞–∫—Ä–æ—Å–Ω–∏–∫–∞ */
        .macro-window {
            position: fixed;
            top: 100px;
            left: 100px;
            width: 500px;
            min-width: 350px;
            min-height: 500px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both;
        }
        
        .macro-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            background-color: var(--primary-color);
            color: white;
        }
        
        .macro-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .macro-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .macro-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .macro-addon-group {
            margin-bottom: 15px;
        }
        
        .macro-addon-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .macro-addon-textarea, .macro-addon-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }
        
        .macro-addon-textarea {
            flex-grow: 1;
            min-height: 100px;
        }
        
        .macro-addon-input[type="number"] {
            width: 80px;
        }
        
        .macro-addon-buttons {
            text-align: center;
            margin-top: 20px;
        }
        
        .macro-addon-button {
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
        }
        
        .macro-addon-button:hover {
            opacity: 0.9;
        }
        
        .macro-addon-button:disabled {
            background-color: #ccc;
            cursor: default;
        }
        
        .macro-addon-status {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
        }
        
        .macro-addon-autosave {
            border-top: 1px solid #ccc;
            padding-top: 15px;
            margin-top: auto;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .message {
                max-width: 95%;
            }
            
            .context-limit {
                width: 40px;
                padding: 10px 2px;
            }
            
            .chats-sidebar {
                width: 200px;
            }
            
            .debug-panel {
                width: 90%;
                right: 5%;
                left: 5%;
            }
        }
    </style>
</head>
<body>
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —á–∞—Ç–∞–º–∏ -->
    <div id="chats-sidebar" class="chats-sidebar">
        <div class="chats-header">
            <h2>–ß–∞—Ç—ã</h2>
            <button id="new-chat-btn" class="new-chat-btn" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç">+</button>
        </div>
        <div id="chats-list" class="chats-list">
            <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div id="resize-handle" class="resize-handle"></div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <div class="header">
            <div class="title">LLM Chat</div>
            <div class="header-actions">
                <div class="auto-scroll-container">
                    <label class="auto-scroll-label">
                        <input type="checkbox" id="auto-scroll-toggle" checked>
                        <span>–ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞</span>
                    </label>
                </div>
                <button id="debug-btn" title="–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å" class="settings-btn">
                    <span>üêû</span> Debug
                </button>
                <button id="macro-btn" title="Open Macro Tool" class="settings-btn">
                    <span>ü§ñ</span> –ú–∞–∫—Ä–æ—Å
                </button>
                <button id="download-btn" title="Download AI Responses" class="settings-btn">
                    <span>üì•</span> Download
                </button>
                <button id="settings-btn" class="settings-btn">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </div>
        
        <div id="chat-container" class="chat-container">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <div class="input-container">
            <input id="context-limit" class="context-limit" type="text" value="-" title="Context window size (number of messages to include)">
            <div class="input-wrapper">
                <textarea id="message-input" class="message-input" placeholder="Type your message here..."></textarea>
            </div>
            <div class="action-buttons">
                <button id="send-btn" class="send-btn" title="Send message">
                    üì§
                </button>
                <button id="stop-btn" class="stop-btn" title="Stop generating" disabled>
                    ‚èπÔ∏è
                </button>
                <button id="regenerate-btn" class="regenerate-btn" title="Regenerate last response" disabled>
                    üîÑ
                </button>
            </div>
        </div>
    </div>
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div id="debug-panel" class="debug-panel">
        <div class="debug-header">
            <div class="debug-title">Debug Panel</div>
            <button id="debug-close" class="debug-close">&times;</button>
        </div>
        <div id="debug-content" class="debug-content">
            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button id="close-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="form-group">
                <label for="model-select" class="form-label">Model</label>
                <select id="model-select" class="form-select">
                    <option value="openrouter:anthropic/claude-3.7-sonnet:thinking">Claude 3.7 Sonnet (Thinking)</option>
                    <option value="openrouter:anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="openrouter:anthropic/claude-3-opus">Claude 3 Opus</option>
                    <option value="openrouter:openai/gpt-4o">GPT-4o</option>
                    <option value="openrouter:google/gemini-pro">Gemini Pro</option>
                    <option value="openrouter:meta-llama/llama-3-70b-instruct">Llama 3 70B</option>
                    <option value="custom">Custom model...</option>
                </select>
            </div>
            <div id="custom-model-container" class="form-group" style="display: none;">
                <label for="custom-model" class="form-label">Custom Model Name</label>
                <input id="custom-model" class="form-input" type="text" placeholder="e.g. openrouter:anthropic/claude-3-haiku">
            </div>
            <div class="form-group">
                <label for="temperature" class="form-label">Temperature: <span id="temperature-value">0.7</span></label>
                <input id="temperature" class="form-input" type="range" min="0" max="1" step="0.1" value="0.7">
            </div>
            <div class="form-group">
                <label for="max-tokens" class="form-label">Max Tokens</label>
                <input id="max-tokens" class="form-input" type="number" min="100" max="100000" value="4096">
            </div>
            <div class="form-group">
                <label for="system-prompt" class="form-label">System Prompt</label>
                <textarea id="system-prompt" class="form-textarea" placeholder="Instructions for the AI..."></textarea>
            </div>
            <button id="save-settings-btn" class="save-settings-btn">Save Settings</button>
        </div>
    </div>
    
    <!-- Macro Window -->
    <div id="macro-window" class="macro-window">
        <div id="macro-header" class="macro-header">
            <div class="macro-title">–ê–¥–¥–æ–Ω-–º–∞–∫—Ä–æ—Å–Ω–∏–∫</div>
            <button id="macro-close-btn" class="macro-close-btn">&times;</button>
        </div>
        <div class="macro-content">
            <div class="macro-addon-group">
                <label for="macro-template-textarea" class="macro-addon-label"><b>–¢–µ–∫—Å—Ç-—à–∞–±–ª–æ–Ω:</b></label>
                <textarea id="macro-template-textarea" class="macro-addon-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [] –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, {} –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ <> –¥–ª—è —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª."></textarea>
            </div>
            <div class="macro-addon-group">
                <label for="macro-variables-textarea" class="macro-addon-label"><b>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ([]):</b></label>
                <textarea id="macro-variables-textarea" class="macro-addon-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É. –û–Ω–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–º–µ—Å—Ç–æ []"></textarea>
            </div>
            <div class="macro-addon-group">
                <label for="macro-keywords-textarea" class="macro-addon-label"><b>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ({}):</b></label>
                <textarea id="macro-keywords-textarea" class="macro-addon-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É. –°–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –≤–º–µ—Å—Ç–æ {}"></textarea>
            </div>
            <div class="macro-addon-group">
                <label class="macro-addon-label"><b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:</b></label>
                <div style="display: flex; align-items: center;">
                    <span style="margin-right: 5px;">–æ—Ç</span>
                    <input type="number" id="macro-keywords-count-min-input" class="macro-addon-input" value="1" min="1">
                    <span style="margin-left: 5px; margin-right: 5px;">–¥–æ</span>
                    <input type="number" id="macro-keywords-count-max-input" class="macro-addon-input" value="3" min="1">
                </div>
            </div>
            <div class="macro-addon-group">
                <label class="macro-addon-label"><b>–î–∏–∞–ø–∞–∑–æ–Ω —á–∏—Å–µ–ª (&lt;&gt;):</b></label>
                <div style="display: flex; align-items: center;">
                    <span style="margin-right: 5px;">–æ—Ç</span>
                    <input type="number" id="macro-number-range-min-input" class="macro-addon-input" value="1000" min="1">
                    <span style="margin-left: 5px; margin-right: 5px;">–¥–æ</span>
                    <input type="number" id="macro-number-range-max-input" class="macro-addon-input" value="2000" min="1">
                </div>
            </div>
            <div class="macro-addon-autosave">
                <div class="macro-addon-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="macro-save-history-checkbox">
                        –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∂–¥—ã–µ 
                        <input type="number" id="macro-save-interval-input" 
                               style="width: 70px; padding: 5px;" 
                               min="1" value="5" 
                               disabled>
                        –æ—Ç–≤–µ—Ç–æ–≤
                    </label>
                </div>
            </div>
            <div class="macro-addon-buttons">
                <button id="macro-start-button" class="macro-addon-button">–°—Ç–∞—Ä—Ç</button>
                <button id="macro-pause-button" class="macro-addon-button" disabled>–ü–∞—É–∑–∞</button>
                <button id="macro-stop-button" class="macro-addon-button" disabled>–°—Ç–æ–ø</button>
            </div>
            <div class="macro-addon-status">
                <b>–°–µ–∫—É–Ω–¥–æ–º–µ—Ä: <span id="macro-stopwatch">0 —Å–µ–∫</span></b> 
                <span id="macro-variable-counter"></span>
            </div>
        </div>
    </div>

        <script>
        // **–ü–µ—Ä–µ–º–µ—â–∞–µ–º –±–ª–æ–∫ marked.setOptions —Å—é–¥–∞, –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ highlight.js**
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ marked –¥–ª—è Markdown
        marked.setOptions({
            renderer: new marked.Renderer(),
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-', // –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è CSS-–∫–ª–∞—Å—Å–æ–≤ highlight.js
            breaks: true,                  // —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏ –∫–∞–∫ <br>
            gfm: true,                     // —Ä–∞–∑—Ä–µ—à–∞–µ–º GitHub Flavored Markdown
            headerIds: false,              // –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ ID –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            sanitize: false                // –Ω–µ —Å–∞–Ω–∏—Ç–∞–π–∑–∏–º HTML (marked –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
        });

        // Configuration object with default settings
        const defaultConfig = {
            model: "openrouter:anthropic/claude-3.7-sonnet:thinking",
            temperature: 0.7,
            maxTokens: 4096,
            systemPrompt: ""
        };

        // Current configuration (will be loaded from localStorage if available)
        let config = { ...defaultConfig };

        // –û–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        let debugInfo = {
            model: "",
            status: "",
            lastChunk: null,
            error: null,
            startTime: null,
            endTime: null,
            totalTokens: 0
        };

        // –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        const MESSAGE_STATUS = {
            SENDING: "sending",
            WAITING: "waiting",
            THINKING: "thinking",
            ERROR: "error",
            NONE: ""
        };

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏
        let chats = [];
        let activeChat = null;
        let isResizing = false;
        let autoScroll = true;

        // DOM elements
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const contextLimit = document.getElementById('context-limit');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const regenerateBtn = document.getElementById('regenerate-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const downloadBtn = document.getElementById('download-btn');
        const debugBtn = document.getElementById('debug-btn');
        const debugPanel = document.getElementById('debug-panel');
        const debugContent = document.getElementById('debug-content');
        const debugClose = document.getElementById('debug-close');
        const settingsModal = document.getElementById('settings-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modelSelect = document.getElementById('model-select');
        const customModelContainer = document.getElementById('custom-model-container');
        const customModel = document.getElementById('custom-model');
        const temperature = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        const maxTokens = document.getElementById('max-tokens');
        const systemPrompt = document.getElementById('system-prompt');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const chatsSidebar = document.getElementById('chats-sidebar');
        const resizeHandle = document.getElementById('resize-handle');
        const autoScrollToggle = document.getElementById('auto-scroll-toggle');
        const chatsListElement = document.getElementById('chats-list');
        const newChatBtn = document.getElementById('new-chat-btn');

        // –ú–∞–∫—Ä–æ—Å–Ω–∏–∫ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const macroBtn = document.getElementById('macro-btn');
        const macroWindow = document.getElementById('macro-window');
        const macroCloseBtn = document.getElementById('macro-close-btn');
        const macroHeader = document.getElementById('macro-header');
        const templateTextArea = document.getElementById('macro-template-textarea');
        const variablesTextArea = document.getElementById('macro-variables-textarea');
        const keywordsTextArea = document.getElementById('macro-keywords-textarea');
        const keywordsCountMinInput = document.getElementById('macro-keywords-count-min-input');
        const keywordsCountMaxInput = document.getElementById('macro-keywords-count-max-input');
        const numberRangeMinInput = document.getElementById('macro-number-range-min-input');
        const numberRangeMaxInput = document.getElementById('macro-number-range-max-input');
        const startButton = document.getElementById('macro-start-button');
        const pauseButton = document.getElementById('macro-pause-button');
        const stopButton = document.getElementById('macro-stop-button');
        const stopwatchDisplay = document.getElementById('macro-stopwatch');
        const variableCounterDisplay = document.getElementById('macro-variable-counter');
        const saveHistoryCheckbox = document.getElementById('macro-save-history-checkbox');
        const saveIntervalInput = document.getElementById('macro-save-interval-input');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∞–∫—Ä–æ—Å–Ω–∏–∫–∞
        let macroRunning = false;
        let macroPaused = false;
        let variableLines = [];
        let currentVariableIndex = 0;
        let messageCheckInterval = null;
        let lastMessageTime = null;
        let stopwatchInterval = null;
        let totalVariablesCount = 0;
        let llmResponsesCounter = 0;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –æ–∫–Ω–∞
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function createChat(title = "–ù–æ–≤—ã–π —á–∞—Ç") {
            const chatId = Date.now().toString();
            const newChat = {
                id: chatId,
                title: title,
                messages: [],
                abortController: null,
                contextLimit: "-"
            };

            chats.push(newChat);
            saveChats();

            return newChat;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –≤ localStorage
        function saveChats() {
            const chatsToSave = chats.map(chat => {
                const { abortController, ...chatToSave } = chat;
                return chatToSave;
            });

            localStorage.setItem('claudeChats', JSON.stringify(chatsToSave));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –∏–∑ localStorage
        function loadChats() {
            const savedChats = localStorage.getItem('claudeChats');
            if (savedChats) {
                try {
                    chats = JSON.parse(savedChats).map(chat => ({
                        ...chat,
                        abortController: null
                    }));

                    if (chats.length > 0) {
                        activeChat = chats[0];
                    } else {
                        activeChat = createChat();
                    }

                } catch (e) {
                    console.error('Error loading chats:', e);
                    chats = [];
                    activeChat = createChat();
                }
            } else {
                activeChat = createChat();
            }

            renderChatsList();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
            if (activeChat) {
                contextLimit.value = activeChat.contextLimit || "-";
                renderMessages();
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function renderChatsList() {
            chatsListElement.innerHTML = '';

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === activeChat.id ? 'active' : ''}`;
                chatItem.dataset.id = chat.id;

                const chatTitle = document.createElement('div');
                chatTitle.className = 'chat-title';
                chatTitle.textContent = chat.title;

                const chatActions = document.createElement('div');
                chatActions.className = 'chat-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'chat-action-btn';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.title = '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —á–∞—Ç';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', chat.title);
                    if (newTitle !== null && newTitle.trim() !== '') {
                        chat.title = newTitle.trim();
                        saveChats();
                        renderChatsList();
                    }
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'chat-action-btn';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${chat.title}"?`)) {
                        const index = chats.findIndex(c => c.id === chat.id);
                        if (index !== -1) {
                            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                            if (chat.abortController) {
                                chat.abortController.abort();
                            }

                            chats.splice(index, 1);

                            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                            if (chat.id === activeChat.id) {
                                if (chats.length > 0) {
                                    activeChat = chats[0];
                                } else {
                                    activeChat = createChat();
                                }
                                renderMessages();
                            }

                            saveChats();
                            renderChatsList();
                        }
                    }
                });

                chatActions.appendChild(editBtn);
                chatActions.appendChild(deleteBtn);

                chatItem.appendChild(chatTitle);
                chatItem.appendChild(chatActions);

                chatItem.addEventListener('click', () => {
                    switchChat(chat.id);
                });

                chatsListElement.appendChild(chatItem);
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
        function switchChat(chatId) {
            if (activeChat && activeChat.id === chatId) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
            if (activeChat) {
                activeChat.contextLimit = contextLimit.value;
            }

            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            const newActiveChat = chats.find(chat => chat.id === chatId);
            if (!newActiveChat) return;

            activeChat = newActiveChat;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderChatsList();
            renderMessages();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
            contextLimit.value = activeChat.contextLimit || "-";

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ–∫—É—â–∏–º —á–∞—Ç–æ–º
            updateButtonState();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç—ã
            saveChats();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        function updateButtonState() {
            if (activeChat && activeChat.abortController) {
                sendBtn.disabled = true;
                stopBtn.disabled = false;
                regenerateBtn.disabled = true;
            } else {
                sendBtn.disabled = false;
                stopBtn.disabled = true;
                regenerateBtn.disabled = activeChat && activeChat.messages &&
                                        activeChat.messages.some(m => m.role === 'assistant') ? false : true;
            }
        }

        // Load configuration from localStorage
        function loadConfig() {
            const savedConfig = localStorage.getItem('claudeChatConfig');
            if (savedConfig) {
                try {
                    config = { ...defaultConfig, ...JSON.parse(savedConfig) };

                    // Update UI with loaded settings
                    temperature.value = config.temperature;
                    temperatureValue.textContent = config.temperature;
                    maxTokens.value = config.maxTokens;
                    systemPrompt.value = config.systemPrompt || '';

                    // Handle custom model
                    const savedCustomModelValue = localStorage.getItem('customModelValue');

                    if (modelSelect.querySelector(`option[value="${config.model}"]`)) {
                        modelSelect.value = config.model;
                    } else {
                        modelSelect.value = 'custom';
                        customModelContainer.style.display = 'block';

                        if (savedCustomModelValue) {
                            customModel.value = savedCustomModelValue;
                        } else {
                            customModel.value = config.model;
                        }
                    }
                } catch (e) {
                    console.error('Error loading config:', e);
                    config = { ...defaultConfig };
                }
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('claudeChatConfig', JSON.stringify(config));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–±–∞–≥-–ø–∞–Ω–µ–ª–∏
        function updateDebugPanel() {
            if (debugPanel.style.display !== 'flex') return;

            let content = '';

            // –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            content += `<div class="debug-info">
                <span class="debug-label">Model:</span>
                <span class="debug-value">${debugInfo.model || config.model}</span>
            </div>`;

            content += `<div class="debug-info">
                <span class="debug-label">Status:</span>
                <span class="debug-value">${debugInfo.status}</span>
            </div>`;

            if (debugInfo.startTime) {
                content += `<div class="debug-info">
                    <span class="debug-label">Started:</span>
                    <span class="debug-value">${new Date(debugInfo.startTime).toLocaleTimeString()}</span>
                </div>`;
            }

            if (debugInfo.endTime) {
                content += `<div class="debug-info">
                    <span class="debug-label">Completed:</span>
                    <span class="debug-value">${new Date(debugInfo.endTime).toLocaleTimeString()}</span>
                </div>`;

                const duration = (debugInfo.endTime - debugInfo.startTime) / 1000;
                content += `<div class="debug-info">
                    <span class="debug-label">Duration:</span>
                    <span class="debug-value">${duration.toFixed(2)} seconds</span>
                </div>`;
            }

            if (debugInfo.error) {
                content += `<div class="debug-info">
                    <span class="debug-label">Error:</span>
                    <span class="debug-value error">${debugInfo.error}</span>
                </div>`;
            }

            // –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –¥–∞–Ω–Ω—ã—Ö
            if (debugInfo.lastChunk) {
                content += `<div class="debug-info">
                    <span class="debug-label">Last chunk data:</span>
                    <div class="debug-raw">${JSON.stringify(debugInfo.lastChunk, null, 2)}</div>
                </div>`;
            }

            debugContent.innerHTML = content;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function setMessageStatus(messageId, status) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (!messageElement) return;

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
            const oldIndicator = messageElement.querySelector('.status-indicator');
            if (oldIndicator) oldIndicator.remove();

            const oldStatusText = messageElement.querySelector('.status-text');
            if (oldStatusText) oldStatusText.remove();

            // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞, –≤—ã—Ö–æ–¥–∏–º
            if (!status || status === MESSAGE_STATUS.NONE) return;

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
            const messageSender = messageElement.querySelector('.message-sender');

            const statusIndicator = document.createElement('span');
            statusIndicator.className = `status-indicator ${status}`;
            messageSender.appendChild(statusIndicator);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            const statusText = document.createElement('span');
            statusText.className = 'status-text';

            switch (status) {
                case MESSAGE_STATUS.SENDING:
                    statusText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                    break;
                case MESSAGE_STATUS.WAITING:
                    statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...';
                    break;
                case MESSAGE_STATUS.THINKING:
                    statusText.textContent = '–û–±–¥—É–º—ã–≤–∞–Ω–∏–µ...';
                    break;
                case MESSAGE_STATUS.ERROR:
                    statusText.textContent = '–û—à–∏–±–∫–∞';
                    break;
            }

            messageSender.appendChild(statusText);
        }

        // Add a new message to the chat
        function addMessage(role, content, isStreaming = false, status = MESSAGE_STATUS.NONE) {
            const messageId = Date.now().toString();

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
            if (!activeChat.messages) {
                activeChat.messages = [];
            }

            activeChat.messages.push({
                id: messageId,
                role,
                content,
                timestamp: new Date().toISOString(),
                status: status
            });

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            const contextMessages = prepareContextWindow();
            const isInContext = contextMessages.some(msg => msg.id === messageId);

            renderMessage(activeChat.messages[activeChat.messages.length - 1], isStreaming, isInContext);
            saveChats();

            return messageId;
        }

        // Update an existing message
        function updateMessage(id, content, status = null) {
            const index = activeChat.messages.findIndex(m => m.id === id);
            if (index !== -1) {
                activeChat.messages[index].content = content;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω
                if (status !== null) {
                    activeChat.messages[index].status = status;
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                const contextMessages = prepareContextWindow();
                const isInContext = contextMessages.some(msg => msg.id === id);

                const messageElement = document.getElementById(`message-${id}`);
                if (messageElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    if (isInContext) {
                        messageElement.classList.add('in-context');
                    } else {
                        messageElement.classList.remove('in-context');
                    }

                    const contentElement = messageElement.querySelector('.message-content');
                    contentElement.innerHTML = marked.parse(content);

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                    addCopyButtonsToCodeBlocks(contentElement);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
                    const charCountElement = messageElement.querySelector('.char-count');
                    charCountElement.textContent = `${content.length} characters`;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
                    if (status !== null) {
                        setMessageStatus(id, status);
                    }
                }

                saveChats();
            }
        }

        // Delete a message
        function deleteMessage(id) {
            const index = activeChat.messages.findIndex(m => m.id === id);
            if (index !== -1) {
                activeChat.messages.splice(index, 1);

                const messageElement = document.getElementById(`message-${id}`);
                if (messageElement) {
                    messageElement.remove();
                }

                saveChats();
                updateContextHighlighting();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        function updateContextHighlighting() {
            if (!activeChat || !activeChat.messages) return;

            const contextMessages = prepareContextWindow();
            const contextMessageIds = contextMessages.map(msg => msg.id);

            activeChat.messages.forEach(message => {
                const messageElement = document.getElementById(`message-${message.id}`);
                if (messageElement) {
                    if (contextMessageIds.includes(message.id)) {
                        messageElement.classList.add('in-context');
                    } else {
                        messageElement.classList.remove('in-context');
                    }
                }
            });
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function editMessageInUI(messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (!messageElement) return;

            const messageIndex = activeChat.messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            const message = activeChat.messages[messageIndex];
            const contentElement = messageElement.querySelector('.message-content');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–º–µ–Ω—ã
            const originalContent = message.content;

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editContainer = document.createElement('div');
            editContainer.className = 'message-edit-container';

            // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editTextarea = document.createElement('textarea');
            editTextarea.className = 'message-edit-textarea';
            editTextarea.value = originalContent;

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
            const editActions = document.createElement('div');
            editActions.className = 'message-edit-actions';

            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveButton = document.createElement('button');
            saveButton.className = 'message-edit-save';
            saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';

            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
            const cancelButton = document.createElement('button');
            cancelButton.className = 'message-edit-cancel';
            cancelButton.textContent = '–û—Ç–º–µ–Ω–∞';

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            editActions.appendChild(saveButton);
            editActions.appendChild(cancelButton);
            editContainer.appendChild(editTextarea);
            editContainer.appendChild(editActions);

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            contentElement.style.display = 'none';
            messageElement.insertBefore(editContainer, messageElement.querySelector('.char-count'));

            // –§–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
            editTextarea.focus();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            saveButton.addEventListener('click', () => {
                const newContent = editTextarea.value.trim();
                if (newContent) {
                    updateMessage(messageId, newContent);
                }

                // –£–¥–∞–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                contentElement.style.display = '';
                editContainer.remove();
            });

            cancelButton.addEventListener('click', () => {
                // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                contentElement.style.display = '';
                editContainer.remove();
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
        function addCopyButtonsToCodeBlocks(element) {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏ pre>code
            const codeBlocks = element.querySelectorAll('pre > code');

            codeBlocks.forEach((codeBlock, index) => {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π pre-—ç–ª–µ–º–µ–Ω—Ç
                const preBlock = codeBlock.parentNode;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                if (!preBlock.querySelector('.copy-code-btn')) {
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-code-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.setAttribute('aria-label', 'Copy code to clipboard');

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–∞
                    copyButton.addEventListener('click', function() {
                        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∫–æ–¥–∞
                        const code = codeBlock.textContent;

                        // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                                const originalText = this.textContent;
                                this.textContent = 'Copied!';
                                setTimeout(() => {
                                    this.textContent = originalText;
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy code: ', err);
                                this.textContent = 'Error!';
                                setTimeout(() => {
                                    this.textContent = 'Copy';
                                }, 2000);
                            });
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫ –±–ª–æ–∫—É pre
                    preBlock.appendChild(copyButton);
                }
            });
        }

        // Render all messages
        function renderMessages() {
            chatContainer.innerHTML = '';

            if (!activeChat || !activeChat.messages || activeChat.messages.length === 0) {
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            const contextMessages = prepareContextWindow();
            const contextMessageIds = contextMessages.map(msg => msg.id);

            activeChat.messages.forEach(message => {
                renderMessage(message, false, contextMessageIds.includes(message.id));
            });
        }

        // Render a single message
        function renderMessage(message, isStreaming = false, isInContext = false) {
            let messageElement = document.getElementById(`message-${message.id}`);
            const isNewMessage = !messageElement;

            if (isNewMessage) {
                messageElement = document.createElement('div');
                messageElement.id = `message-${message.id}`;
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : 'bot-message'} ${isInContext ? 'in-context' : ''}`;

                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';

                const messageSender = document.createElement('div');
                messageSender.className = 'message-sender';
                messageSender.textContent = message.role === 'user' ? 'You' : 'LLM';

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (message.status && message.status !== MESSAGE_STATUS.NONE) {
                    const statusIndicator = document.createElement('span');
                    statusIndicator.className = `status-indicator ${message.status}`;
                    messageSender.appendChild(statusIndicator);

                    const statusText = document.createElement('span');
                    statusText.className = 'status-text';

                    switch (message.status) {
                        case MESSAGE_STATUS.SENDING:
                            statusText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                            break;
                        case MESSAGE_STATUS.WAITING:
                            statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...';
                            break;
                        case MESSAGE_STATUS.THINKING:
                            statusText.textContent = '–û–±–¥—É–º—ã–≤–∞–Ω–∏–µ...';
                            break;
                        case MESSAGE_STATUS.ERROR:
                            statusText.textContent = '–û—à–∏–±–∫–∞';
                            break;
                    }

                    messageSender.appendChild(statusText);
                }

                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Edit message';
                editBtn.addEventListener('click', () => {
                    editMessageInUI(message.id);
                });

                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn';
                copyBtn.textContent = 'üìã';
                copyBtn.title = 'Copy message';
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message.content);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'Delete message';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this message?')) {
                        deleteMessage(message.id);
                    }
                });

                messageActions.appendChild(editBtn);
                messageActions.appendChild(copyBtn);
                messageActions.appendChild(deleteBtn);

                messageHeader.appendChild(messageSender);
                messageHeader.appendChild(messageActions);

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º marked –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Markdown
                messageContent.innerHTML = marked.parse(message.content);

                const charCount = document.createElement('div');
                charCount.className = 'char-count';
                charCount.textContent = `${message.content.length} characters`;

                messageElement.appendChild(messageHeader);
                messageElement.appendChild(messageContent);
                messageElement.appendChild(charCount);

                chatContainer.appendChild(messageElement);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                addCopyButtonsToCodeBlocks(messageContent);

            } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                if (isInContext) {
                    messageElement.classList.add('in-context');
                } else {
                    messageElement.classList.remove('in-context');
                }

                if (!isStreaming) {
                    // Update existing message
                    const contentElement = messageElement.querySelector('.message-content');
                    contentElement.innerHTML = marked.parse(message.content);

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                    addCopyButtonsToCodeBlocks(contentElement);

                    const charCountElement = messageElement.querySelector('.char-count');
                    charCountElement.textContent = `${message.content.length} characters`;
                }
            }

            // Scroll to the latest message only if auto-scroll is enabled
            if (isNewMessage && autoScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Prepare the context window based on the limit setting
        function prepareContextWindow() {
            if (!activeChat || !activeChat.messages) return [];

            const limit = contextLimit.value.trim();

            if (limit === '-' || limit === '') {
                // Return all messages
                return [...activeChat.messages];
            }

            const numericLimit = parseInt(limit);
            if (isNaN(numericLimit) || numericLimit <= 0) {
                return [...activeChat.messages];
            }

            // Return the last N messages
            return activeChat.messages.slice(-numericLimit);
        }

        // Send message to the LLM
        async function sendMessage(messageContent = null) {
            const userInput = messageContent || messageInput.value.trim();
            if (!userInput) return;

            // Add user message to chat
            addMessage('user', userInput);

            // Clear input
            if (!messageContent) {
                messageInput.value = '';
            }

            // Prepare context window for API call
            const contextWindow = prepareContextWindow();

            // Add an empty bot message (for streaming) —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–æ—Ç–ø—Ä–∞–≤–∫–∞"
            const botMessageId = addMessage('assistant', '', true, MESSAGE_STATUS.SENDING);
            const botMessage = document.getElementById(`message-${botMessageId}`);
            const botMessageContent = botMessage.querySelector('.message-content');

            // Enable stop button, disable send and regenerate
            sendBtn.disabled = true;
            stopBtn.disabled = false;
            regenerateBtn.disabled = true;

            let fullResponse = '';
            activeChat.abortController = new AbortController();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            debugInfo = {
                model: config.model,
                status: 'sending',
                lastChunk: null,
                error: null,
                startTime: Date.now(),
                endTime: null,
                totalTokens: 0
            };
            updateDebugPanel();

            // –î–ª—è –º–∞–∫—Ä–æ—Å–∞: –Ω–∞—á–∞—Ç—å –æ—Ç—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            if (macroRunning) {
                startStopwatch();
            }

            try {
                // Build messages array for API
                const apiMessages = [];

                // Add system prompt if set
                if (config.systemPrompt) {
                    apiMessages.push({
                        role: 'system',
                        content: config.systemPrompt
                    });
                }

                // Add context messages
                contextWindow.forEach(msg => {
                    apiMessages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });

                // –ò–∑–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ "–æ–∂–∏–¥–∞–Ω–∏–µ"
                updateMessage(botMessageId, '', MESSAGE_STATUS.WAITING);
                debugInfo.status = 'waiting';
                updateDebugPanel();

                // Call LLM API with streaming
                const response = await puter.ai.chat(
                    apiMessages.length === 0 ? userInput : apiMessages,
                    {
                        model: config.model,
                        temperature: parseFloat(config.temperature),
                        max_tokens: parseInt(config.maxTokens),
                        stream: true,
                        signal: activeChat.abortController.signal
                    }
                );

                // Process streaming response
                for await (const part of response) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    debugInfo.lastChunk = part;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç thinking –∏–ª–∏ reasoning
                    if (part?.thinking || part?.reasoning) {
                        if (debugInfo.status !== 'thinking') {
                            debugInfo.status = 'thinking';
                            updateMessage(botMessageId, fullResponse, MESSAGE_STATUS.THINKING);
                        }
                    }

                    if (part?.text) {
                        fullResponse += part.text;

                        // –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ —á–∞—Ç)
                        const currentBotMessage = document.getElementById(`message-${botMessageId}`);
                        if (currentBotMessage) {
                            const currentBotMessageContent = currentBotMessage.querySelector('.message-content');
                            currentBotMessageContent.innerHTML = marked.parse(fullResponse);

                            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –Ω–æ–≤—ã–º –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                            addCopyButtonsToCodeBlocks(currentBotMessageContent);

                            currentBotMessage.querySelector('.char-count').textContent = `${fullResponse.length} characters`;

                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
                            if (autoScroll) {
                                currentBotMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            }
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ
                        const messageIndex = activeChat.messages.findIndex(m => m.id === botMessageId);
                        if (messageIndex !== -1) {
                            activeChat.messages[messageIndex].content = fullResponse;
                            saveChats();
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
                    updateDebugPanel();
                }

                // –°—Ç—Ä–∏–º–º–∏–Ω–≥ –∑–∞–∫–æ–Ω—á–µ–Ω, —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å
                debugInfo.status = 'completed';
                debugInfo.endTime = Date.now();
                updateMessage(botMessageId, fullResponse, MESSAGE_STATUS.NONE);
                updateDebugPanel();

                // –î–ª—è –º–∞–∫—Ä–æ—Å–∞: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤
                if (macroRunning) {
                    llmResponsesCounter++;
                    stopStopwatch();

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    if (saveHistoryCheckbox.checked) {
                        const interval = parseInt(saveIntervalInput.value);
                        if (llmResponsesCounter >= interval) {
                            downloadAIResponses();
                            llmResponsesCounter = 0;

                            // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                            setTimeout(() => {
                                clearChat();
                            }, 1000);
                        }
                    }

                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –≤ –º–∞–∫—Ä–æ—Å–µ
                    if (templateTextArea.value.includes('[]')) {
                        currentVariableIndex++;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    if (templateTextArea.value.includes('[]') && currentVariableIndex >= variableLines.length) {
                        stopMacro();
                        alert('–ú–∞–∫—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.');
                    } else if (macroRunning && !macroPaused) {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        setTimeout(sendNextMessage, 1000);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                    debugInfo.status = 'aborted';
                    debugInfo.endTime = Date.now();
                    debugInfo.error = 'Request aborted by user';
                } else {
                    console.error('Error calling LLM:', error);
                    debugInfo.status = 'error';
                    debugInfo.endTime = Date.now();
                    debugInfo.error = error.message;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ
                    const messageIndex = activeChat.messages.findIndex(m => m.id === botMessageId);
                    if (messageIndex !== -1) {
                        activeChat.messages[messageIndex].content = `Error: ${error.message}`;
                        activeChat.messages[messageIndex].status = MESSAGE_STATUS.ERROR;
                        saveChats();

                        // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ
                        const currentBotMessage = document.getElementById(`message-${botMessageId}`);
                        if (currentBotMessage) {
                            const currentBotMessageContent = currentBotMessage.querySelector('.message-content');
                            currentBotMessageContent.innerHTML = `Error: ${error.message}`;
                            currentBotMessage.querySelector('.char-count').textContent = `${(`Error: ${error.message}`).length} characters`;
                            setMessageStatus(botMessageId, MESSAGE_STATUS.ERROR);
                        }
                    }
                }

                updateDebugPanel();

                if (macroRunning) {
                    stopStopwatch();
                }
            } finally {
                // Reset UI state
                activeChat.abortController = null;
                sendBtn.disabled = false;
                stopBtn.disabled = true;
                regenerateBtn.disabled = false;
            }
        }

        // Regenerate the last bot response
        async function regenerateLastResponse() {
            if (!activeChat || !activeChat.messages) return;

            // Find the last bot message
            const lastBotMessageIndex = [...activeChat.messages].reverse().findIndex(m => m.role === 'assistant');
            if (lastBotMessageIndex === -1) return;

            const lastBotMessage = activeChat.messages[activeChat.messages.length - 1 - lastBotMessageIndex];

            // Prepare context up to the last user message
            const contextMessages = activeChat.messages.slice(0, activeChat.messages.length - 1 - lastBotMessageIndex);

            // Delete last bot message
            deleteMessage(lastBotMessage.id);

            // Disable buttons
            sendBtn.disabled = true;
            regenerateBtn.disabled = true;
            stopBtn.disabled = false;

            // Add an empty bot message (for streaming) —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–æ—Ç–ø—Ä–∞–≤–∫–∞"
            const botMessageId = addMessage('assistant', '', true, MESSAGE_STATUS.SENDING);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            debugInfo = {
                model: config.model,
                status: 'regenerating',
                lastChunk: null,
                error: null,
                startTime: Date.now(),
                endTime: null,
                totalTokens: 0
            };
            updateDebugPanel();

            let fullResponse = '';
            activeChat.abortController = new AbortController();

            try {
                // Build messages array for API
                const apiMessages = [];

                // Add system prompt if set
                if (config.systemPrompt) {
                    apiMessages.push({
                        role: 'system',
                        content: config.systemPrompt
                    });
                }

                // Add context messages
                contextMessages.forEach(msg => {
                    apiMessages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });

                // –ò–∑–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ "–æ–∂–∏–¥–∞–Ω–∏–µ"
                updateMessage(botMessageId, '', MESSAGE_STATUS.WAITING);
                debugInfo.status = 'waiting';
                updateDebugPanel();

                // Call LLM API with streaming
                const response = await puter.ai.chat(
                    apiMessages,
                    {
                        model: config.model,
                        temperature: parseFloat(config.temperature),
                        max_tokens: parseInt(config.maxTokens),
                        stream: true,
                        signal: activeChat.abortController.signal
                    }
                );

                // Process streaming response
                for await (const part of response) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    debugInfo.lastChunk = part;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç thinking –∏–ª–∏ reasoning
                    if (part?.thinking || part?.reasoning) {
                        if (debugInfo.status !== 'thinking') {
                            debugInfo.status = 'thinking';
                            updateMessage(botMessageId, fullResponse, MESSAGE_STATUS.THINKING);
                        }
                    }

                    if (part?.text) {
                        fullResponse += part.text;

                        // –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ —á–∞—Ç)
                        const currentBotMessage = document.getElementById(`message-${botMessageId}`);
                        if (currentBotMessage) {
                            const currentBotMessageContent = currentBotMessage.querySelector('.message-content');
                            currentBotMessageContent.innerHTML = marked.parse(fullResponse);

                            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                            addCopyButtonsToCodeBlocks(currentBotMessageContent);

                            currentBotMessage.querySelector('.char-count').textContent = `${fullResponse.length} characters`;

                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
                            if (autoScroll) {
                                currentBotMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            }
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ
                        const messageIndex = activeChat.messages.findIndex(m => m.id === botMessageId);
                        if (messageIndex !== -1) {
                            activeChat.messages[messageIndex].content = fullResponse;
                            saveChats();
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
                    updateDebugPanel();
                }

                // –°—Ç—Ä–∏–º–º–∏–Ω–≥ –∑–∞–∫–æ–Ω—á–µ–Ω, —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å
                debugInfo.status = 'completed';
                debugInfo.endTime = Date.now();
                updateMessage(botMessageId, fullResponse, MESSAGE_STATUS.NONE);
                updateDebugPanel();

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                    debugInfo.status = 'aborted';
                    debugInfo.endTime = Date.now();
                    debugInfo.error = 'Request aborted by user';
                } else {
                    console.error('Error calling LLM:', error);
                    debugInfo.status = 'error';
                    debugInfo.endTime = Date.now();
                    debugInfo.error = error.message;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ
                    const messageIndex = activeChat.messages.findIndex(m => m.id === botMessageId);
                    if (messageIndex !== -1) {
                        activeChat.messages[messageIndex].content = `Error: ${error.message}`;
                        activeChat.messages[messageIndex].status = MESSAGE_STATUS.ERROR;
                        saveChats();

                        // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ
                        const currentBotMessage = document.getElementById(`message-${botMessageId}`);
                        if (currentBotMessage) {
                            const currentBotMessageContent = currentBotMessage.querySelector('.message-content');
                            currentBotMessageContent.innerHTML = `Error: ${error.message}`;
                            currentBotMessage.querySelector('.char-count').textContent = `${(`Error: ${error.message}`).length} characters`;
                            setMessageStatus(botMessageId, MESSAGE_STATUS.ERROR);
                        }
                    }
                }

                updateDebugPanel();
            } finally {
                // Reset UI state
                activeChat.abortController = null;
                sendBtn.disabled = false;
                stopBtn.disabled = true;
                regenerateBtn.disabled = false;
            }
        }

        // Stop generation
        function stopGeneration() {
            if (activeChat && activeChat.abortController) {
                activeChat.abortController.abort();
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (debugInfo.status !== 'completed' && !debugInfo.endTime) {
                    debugInfo.status = 'aborted';
                    debugInfo.endTime = Date.now();
                    debugInfo.error = 'Request aborted by user';
                    updateDebugPanel();
                }
            }
        }

        // Download AI responses as HTML
        function downloadAIResponses() {
            if (!activeChat || !activeChat.messages) {
                alert('No messages to download.');
                return;
            }

            // Filter only assistant messages
            const aiResponses = activeChat.messages.filter(msg => msg.role === 'assistant');

            if (aiResponses.length === 0) {
                alert('No AI responses to download.');
                return;
            }

            // Create HTML content
            let htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Responses - ${activeChat.title}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .response {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        pre {
            background-color: #f5f7f9;
            border-radius: 6px;
            padding: 12px;
            overflow: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        p {
            margin: 0.75em 0;
        }
        ul, ol {
            padding-left: 2em;
            margin: 0.75em 0;
        }
        blockquote {
            border-left: 3px solid #dfe2e5;
            margin: 0.75em 0;
            padding: 0 0 0 1em;
            color: #666;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 0.375em 0.75em;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>AI Responses - ${activeChat.title}</h1>`;

            // Add each response
            aiResponses.forEach((response, index) => {
                htmlContent += `
    <div class="response">
        ${marked.parse(response.content)}
    </div>`;
            });

            htmlContent += `
</body>
</html>`;

            // Create download link
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-responses-${activeChat.title}-${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(a);
            a.click();

            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }

        // –û—á–∏—Å—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
        function clearChat() {
            if (!activeChat) return;

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
            if (activeChat.abortController) {
                activeChat.abortController.abort();
                activeChat.abortController = null;
            }

            activeChat.messages = [];
            saveChats();
            renderMessages();
        }

        // -------------------- –§—É–Ω–∫—Ü–∏–∏ –º–∞–∫—Ä–æ—Å–Ω–∏–∫–∞ --------------------

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ localStorage
        function saveTextToLocalStorage(key, text) {
            localStorage.setItem(key, text);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–∑ localStorage
        function loadTextFromLocalStorage(key, defaultText = '') {
            return localStorage.getItem(key) || defaultText;
        }

        // –ó–∞–ø—É—Å–∫ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
        function startStopwatch() {
            lastMessageTime = new Date();
            stopwatchDisplay.textContent = '0 —Å–µ–∫';
            stopwatchInterval = setInterval(updateStopwatch, 1000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
        function updateStopwatch() {
            if (!lastMessageTime) return;
            const currentTime = new Date();
            const elapsedSeconds = Math.round((currentTime - lastMessageTime) / 1000);
            stopwatchDisplay.textContent = elapsedSeconds + ' —Å–µ–∫';
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
        function stopStopwatch() {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
            lastMessageTime = null;
            stopwatchDisplay.textContent = '0 —Å–µ–∫';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        function getRandomKeywords(keywordsText, count) {
            const keywords = keywordsText.split('\n').filter(line => line.trim() !== '');
            if (keywords.length === 0) return '';
            if (count > keywords.length) count = keywords.length;
            const shuffledKeywords = keywords.sort(() => 0.5 - Math.random());
            return shuffledKeywords.slice(0, count).join(', ');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        function getRandomNumberInRange(min, max) {
            min = parseInt(min, 10);
            max = parseInt(max, 10);
            if (isNaN(min) || isNaN(max)) return 1;
            if (min > max) return min;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // –ó–∞–ø—É—Å–∫ –º–∞–∫—Ä–æ—Å–∞
        function startMacro() {
            if (macroRunning) {
                alert('–ú–∞–∫—Ä–æ—Å —É–∂–µ –∑–∞–ø—É—â–µ–Ω.');
                return;
            }

            // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—É—Å–∫–µ
            llmResponsesCounter = 0;

            macroRunning = true;
            macroPaused = false;
            startButton.disabled = true;
            pauseButton.disabled = false;
            stopButton.disabled = false;
            templateTextArea.disabled = true;
            variablesTextArea.disabled = true;
            keywordsTextArea.disabled = true;
            keywordsCountMinInput.disabled = true;
            keywordsCountMaxInput.disabled = true;
            numberRangeMinInput.disabled = true;
            numberRangeMaxInput.disabled = true;
            saveHistoryCheckbox.disabled = true;
            saveIntervalInput.disabled = true;

            variableLines = variablesTextArea.value.split('\n').filter(line => line.trim() !== '');
            currentVariableIndex = 0;
            totalVariablesCount = variableLines.length;

            if (variableLines.length === 0 && templateTextArea.value.includes('[]')) {
                alert('–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–æ –≤ —à–∞–±–ª–æ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä [].');
                stopMacro();
                return;
            }
            updateVariableCounter();
            sendNextMessage();
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendNextMessage() {
            if (!macroRunning) return;
            if (macroPaused) return;

            if (templateTextArea.value.includes('[]') && currentVariableIndex >= variableLines.length) {
                stopMacro();
                alert('–ú–∞–∫—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.');
                return;
            }

            let template = templateTextArea.value;
            let messageContent = template;

            if (template.includes('{}')) {
                const minKeywords = keywordsCountMinInput.value;
                const maxKeywords = keywordsCountMaxInput.value;
                const keywordsCount = getRandomNumberInRange(minKeywords, maxKeywords);
                const randomKeywords = getRandomKeywords(keywordsTextArea.value, keywordsCount);
                messageContent = messageContent.replace('{}', randomKeywords);
            }

            if (template.includes('<>')) {
                const minRange = numberRangeMinInput.value;
                const maxRange = numberRangeMaxInput.value;
                const randomNumber = getRandomNumberInRange(minRange, maxRange);
                messageContent = messageContent.replace('<>', randomNumber);
            }

            if (template.includes('[]')) {
                if (variableLines.length > 0 && currentVariableIndex < variableLines.length) {
                    messageContent = messageContent.replace('[]', variableLines[currentVariableIndex]);
                }
                updateVariableCounter();
            } else {
                updateVariableCounter(true);
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            sendMessage(messageContent);
        }

        // –ü–∞—É–∑–∞ –º–∞–∫—Ä–æ—Å–∞
        function pauseMacro() {
            if (!macroRunning || macroPaused) return;

            macroPaused = true;
            pauseButton.disabled = true;
            startButton.disabled = false;

            if (stopwatchInterval) {
                stopStopwatch();
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–∫—Ä–æ—Å–∞
        function stopMacro() {
            macroRunning = false;
            macroPaused = false;
            startButton.disabled = false;
            pauseButton.disabled = true;
            stopButton.disabled = true;
            templateTextArea.disabled = false;
            variablesTextArea.disabled = false;
            keywordsTextArea.disabled = false;
            keywordsCountMinInput.disabled = false;
            keywordsCountMaxInput.disabled = false;
            numberRangeMinInput.disabled = false;
            numberRangeMaxInput.disabled = false;
            saveHistoryCheckbox.disabled = false;
            saveIntervalInput.disabled = false;

            stopStopwatch();
            updateVariableCounter(true);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        function updateVariableCounter(hide = false) {
            if (variableCounterDisplay) {
                if (hide) {
                    variableCounterDisplay.style.display = 'none';
                } else {
                    variableCounterDisplay.style.display = 'inline';
                    variableCounterDisplay.textContent = `(${currentVariableIndex + 1}/${totalVariablesCount})`;
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º –æ–∫–Ω–∞
        function startDrag(e) {
            isDragging = true;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –º—ã—à–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ–∫–Ω–∞
            const rect = macroWindow.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
            document.body.style.userSelect = 'none';
        }

        function drag(e) {
            if (!isDragging) return;

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–∫–Ω–∞
            const newLeft = e.clientX - dragOffsetX;
            const newTop = e.clientY - dragOffsetY;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const maxX = window.innerWidth - macroWindow.offsetWidth;
            const maxY = window.innerHeight - macroWindow.offsetHeight;

            macroWindow.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
            macroWindow.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
        }

        function stopDrag() {
            isDragging = false;
            document.body.style.userSelect = '';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        function handleResize(e) {
            const newWidth = Math.max(200, Math.min(600, e.clientX));
            chatsSidebar.style.width = newWidth + 'px';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∞–∫—Ä–æ—Å–∞
        function loadMacroSettings() {
            templateTextArea.value = loadTextFromLocalStorage('macroTemplateText', '');
            variablesTextArea.value = loadTextFromLocalStorage('macroVariablesText', '');
            keywordsTextArea.value = loadTextFromLocalStorage('macroKeywordsText', '');
            keywordsCountMinInput.value = loadTextFromLocalStorage('macroKeywordsCountMin', '1');
            keywordsCountMaxInput.value = loadTextFromLocalStorage('macroKeywordsCountMax', '3');
            numberRangeMinInput.value = loadTextFromLocalStorage('macroNumberRangeMin', '1000');
            numberRangeMaxInput.value = loadTextFromLocalStorage('macroNumberRangeMax', '2000');
            saveHistoryCheckbox.checked = loadTextFromLocalStorage('macroSaveHistoryEnabled', 'false') === 'true';
            saveIntervalInput.value = loadTextFromLocalStorage('macroSaveInterval', '5');
            saveIntervalInput.disabled = !saveHistoryCheckbox.checked;
        }

        // Event Listeners
        sendBtn.addEventListener('click', () => sendMessage());

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        stopBtn.addEventListener('click', stopGeneration);

        regenerateBtn.addEventListener('click', regenerateLastResponse);

        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å
        debugBtn.addEventListener('click', () => {
            debugPanel.style.display = debugPanel.style.display === 'flex' ? 'none' : 'flex';
            updateDebugPanel();
        });

        debugClose.addEventListener('click', () => {
            debugPanel.style.display = 'none';
        });

        modelSelect.addEventListener('change', () => {
            if (modelSelect.value === 'custom') {
                customModelContainer.style.display = 'block';
            } else {
                customModelContainer.style.display = 'none';
            }
        });

        temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
        });

        saveSettingsBtn.addEventListener('click', () => {
            // Get values from form
            config.temperature = parseFloat(temperature.value);
            config.maxTokens = parseInt(maxTokens.value);
            config.systemPrompt = systemPrompt.value.trim();

            // Handle model selection
            if (modelSelect.value === 'custom') {
                config.model = customModel.value.trim();
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –º–æ–¥–µ–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
                localStorage.setItem('customModelValue', customModel.value.trim());
            } else {
                config.model = modelSelect.value;
            }

            // Save config and close modal
            saveConfig();
            settingsModal.style.display = 'none';
        });

        downloadBtn.addEventListener('click', downloadAIResponses);

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        let isResizingSidebar = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizingSidebar = true;
            document.body.style.cursor = 'col-resize';
            document.addEventListener('mousemove', handleResize);
            e.preventDefault();
        });

        document.addEventListener('mouseup', () => {
            if (isResizingSidebar) {
                isResizingSidebar = false;
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', handleResize);
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        autoScrollToggle.addEventListener('change', () => {
            autoScroll = autoScrollToggle.checked;
            localStorage.setItem('autoScroll', autoScroll);
        });

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
        contextLimit.addEventListener('change', () => {
            if (activeChat) {
                activeChat.contextLimit = contextLimit.value;
                saveChats();
                updateContextHighlighting();
            }
        });

        // –ù–æ–≤—ã–π —á–∞—Ç
        newChatBtn.addEventListener('click', () => {
            activeChat = createChat();
            renderChatsList();
            renderMessages();
            contextLimit.value = "-";
        });

        // Click outside modal to close
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        // Handle ESC key to close modal
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (settingsModal.style.display === 'flex') {
                    settingsModal.style.display = 'none';
                }
                if (debugPanel.style.display === 'flex') {
                    debugPanel.style.display = 'none';
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–∞–∫—Ä–æ—Å–Ω–∏–∫–∞
        macroBtn.addEventListener('click', () => {
            macroWindow.style.display = 'flex';
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            loadMacroSettings();
        });

        macroCloseBtn.addEventListener('click', () => {
            macroWindow.style.display = 'none';
        });

        macroHeader.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);

        startButton.addEventListener('click', startMacro);
        pauseButton.addEventListener('click', pauseMacro);
        stopButton.addEventListener('click', stopMacro);

        templateTextArea.addEventListener('input', () => {
            saveTextToLocalStorage('macroTemplateText', templateTextArea.value);
        });

        variablesTextArea.addEventListener('input', () => {
            saveTextToLocalStorage('macroVariablesText', variablesTextArea.value);
        });

        keywordsTextArea.addEventListener('input', () => {
            saveTextToLocalStorage('macroKeywordsText', keywordsTextArea.value);
        });

        keywordsCountMinInput.addEventListener('input', () => {
            saveTextToLocalStorage('macroKeywordsCountMin', keywordsCountMinInput.value);
        });

        keywordsCountMaxInput.addEventListener('input', () => {
            saveTextToLocalStorage('macroKeywordsCountMax', keywordsCountMaxInput.value);
        });

        numberRangeMinInput.addEventListener('input', () => {
            saveTextToLocalStorage('macroNumberRangeMin', numberRangeMinInput.value);
        });

        numberRangeMaxInput.addEventListener('input', () => {
            saveTextToLocalStorage('macroNumberRangeMax', numberRangeMaxInput.value);
        });

        saveHistoryCheckbox.addEventListener('change', function() {
            saveIntervalInput.disabled = !this.checked;
            saveTextToLocalStorage('macroSaveHistoryEnabled', this.checked);
        });

        saveIntervalInput.addEventListener('input', function() {
            saveTextToLocalStorage('macroSaveInterval', this.value);
        });

        // Initialization
        loadConfig();
        loadChats();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        autoScroll = localStorage.getItem('autoScroll') !== 'false';
        autoScrollToggle.checked = autoScroll;

        // –ï—Å–ª–∏ –Ω–µ—Ç —á–∞—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (activeChat && (!activeChat.messages || activeChat.messages.length === 0)) {
            addMessage('assistant', "# Hello! I'm Claude.\n\nI can help you with various tasks. Here are some of my capabilities:\n\n- Answering questions and providing information\n- Writing and editing content\n- Analyzing data and solving problems\n- Programming assistance and code generation\n- Creative writing and brainstorming\n\nHow can I assist you today?");
        }

        console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Claude Chat —Å —á–∞—Ç–∞–º–∏, –º–∞–∫—Ä–æ—Å–Ω–∏–∫–æ–º –∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ø–∞–Ω–µ–ª—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.');
    </script>
</html>

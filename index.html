<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Chat</title>
    
    <!-- Подключение Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Подключение библиотеки для Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- Подключение библиотеки для подсветки кода -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.js"></script>
    <!-- Явно подключаем языки, которые чаще всего используются в блоках кода -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/css.min.js"></script>
    
    <!-- Стили для интерфейса -->
    <style>
        :root {
            --primary-color: #6e56cf;
            --secondary-color: #f0f0f0;
            --border-color: #e0e0e0;
            --text-color: #333;
            --light-text: #666;
            --user-msg-bg: #f1f5f9;
            --ai-msg-bg: #ffffff;
            --hover-color: #f5f5f5;
            --error-color: #e74c3c;
            --code-bg: #f6f8fa;
            --inline-code-bg: #f1f1f1;
            --blockquote-border: #dfe2e5;
            --table-border: #dfe2e5;
            --thinking-bg: #f8f9fa;
            --loading-color: rgba(110, 86, 207, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #fafafa;
        }
        
        .header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: white;
        }
        
        .title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .settings-btn:hover {
            background-color: var(--hover-color);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .message-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-text);
            padding: 2px;
            font-size: 0.9rem;
        }
        
        .action-btn:hover {
            color: var(--primary-color);
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        /* Markdown styles */
        .message-content p {
            margin: 0.75em 0;
        }
        
        .message-content img {
            max-width: 100%;
            border-radius: 4px;
        }
        
        .message-content h1, 
        .message-content h2, 
        .message-content h3, 
        .message-content h4, 
        .message-content h5, 
        .message-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .message-content h1 {
            font-size: 1.75em;
        }
        
        .message-content h2 {
            font-size: 1.5em;
        }
        
        .message-content h3 {
            font-size: 1.25em;
        }
        
        .message-content h4 {
            font-size: 1em;
        }
        
        .message-content ul, 
        .message-content ol {
            padding-left: 2em;
            margin: 0.75em 0;
        }
        
        .message-content li {
            margin: 0.375em 0;
        }
        
        .message-content blockquote {
            border-left: 3px solid var(--blockquote-border);
            margin: 0.75em 0;
            padding: 0 0 0 1em;
            color: var(--light-text);
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .message-content th, 
        .message-content td {
            border: 1px solid var(--table-border);
            padding: 0.375em 0.75em;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        .message-content pre {
            position: relative;
            background-color: var(--code-bg);
            border-radius: 6px;
            padding: 1em;
            margin: 0.75em 0;
            overflow: auto;
        }
        
        .message-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }
        
        .message-content p > code {
            background-color: var(--inline-code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .copy-code-btn {
            position: absolute;
            top: 7px;
            right: 7px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        pre:hover .copy-code-btn {
            opacity: 1;
        }
        
        .copy-code-btn:hover {
            background-color: white;
        }
        
        .user-message {
            background-color: var(--user-msg-bg);
            align-self: flex-end;
        }
        
        .bot-message {
            background-color: var(--ai-msg-bg);
            align-self: flex-start;
            border: 1px solid var(--border-color);
        }
        
        .char-count {
            font-size: 0.8rem;
            color: var(--light-text);
            margin-top: 5px;
            text-align: right;
        }
        
        .input-container {
            padding: 15px;
            background-color: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .context-limit {
            width: 60px;
            text-align: center;
            padding: 10px 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .message-input {
            width: 100%;
            min-height: 56px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .send-btn, .stop-btn, .regenerate-btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 56px;
        }
        
        .send-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .send-btn:hover {
            opacity: 0.9;
        }
        
        .stop-btn, .regenerate-btn {
            background-color: var(--secondary-color);
        }
        
        .stop-btn:hover, .regenerate-btn:hover {
            background-color: var(--border-color);
        }
        
        /* Стили для модального окна настроек */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }
        
        .save-settings-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-settings-btn:hover {
            opacity: 0.9;
        }
        
        /* Анимации для состояний LLM */
        @keyframes thinking {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        @keyframes sending {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        @keyframes receiving {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes error-shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background-color: var(--thinking-bg);
            border-radius: 8px;
            margin-bottom: 15px;
            max-width: 90%;
            align-self: flex-start;
            animation: thinking 1.5s infinite;
        }
        
        .thinking-indicator .thinking-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        
        .thinking-indicator .thinking-text {
            font-size: 0.9rem;
            color: var(--light-text);
        }
        
        .thinking-indicator .dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 2px;
        }
        
        .thinking-indicator .dot:nth-child(1) {
            animation: dot-bounce 1.4s infinite 0s;
        }
        
        .thinking-indicator .dot:nth-child(2) {
            animation: dot-bounce 1.4s infinite 0.2s;
        }
        
        .thinking-indicator .dot:nth-child(3) {
            animation: dot-bounce 1.4s infinite 0.4s;
        }
        
        @keyframes dot-bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }
        
        .message.sending {
            animation: sending 0.8s ease;
        }
        
        .message.receiving {
            background: linear-gradient(270deg, #f8f9fb, #fff, #f8f9fb);
            background-size: 200% 200%;
            animation: receiving 2s ease infinite;
        }
        
        .message.error {
            border-color: #f8d7da !important;
            background-color: #fff5f5 !important;
            animation: error-shake 0.5s ease;
        }
        
        .message.error .message-content {
            color: var(--error-color);
        }
        
        /* Индикатор понимания (reasoning) */
        .reasoning-indicator {
            margin-bottom: 8px;
            padding: 6px 10px;
            background-color: #e8f4fd;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #0366d6;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .reasoning-indicator svg {
            width: 14px;
            height: 14px;
        }
        
        /* Дополнительные стили для адаптивности */
        @media (max-width: 768px) {
            .message {
                max-width: 95%;
            }
            
            .context-limit {
                width: 40px;
                padding: 10px 2px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Claude Chat</div>
        <div class="header-actions">
            <button id="download-btn" title="Download AI Responses" class="settings-btn">
                <span>📥</span> Download
            </button>
            <button id="settings-btn" class="settings-btn">
                <span>⚙️</span> Settings
            </button>
        </div>
    </div>
    
    <div id="chat-container" class="chat-container">
        <!-- Messages will be added here dynamically -->
    </div>
    
    <div class="input-container">
        <input id="context-limit" class="context-limit" type="text" value="-" title="Context window size (number of messages to include)">
        <div class="input-wrapper">
            <textarea id="message-input" class="message-input" placeholder="Type your message here..."></textarea>
        </div>
        <div class="action-buttons">
            <button id="send-btn" class="send-btn" title="Send message">
                📤
            </button>
            <button id="stop-btn" class="stop-btn" title="Stop generating" disabled>
                ⏹️
            </button>
            <button id="regenerate-btn" class="regenerate-btn" title="Regenerate last response" disabled>
                🔄
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button id="close-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="form-group">
                <label for="model-select" class="form-label">Model</label>
                <select id="model-select" class="form-select">
                    <option value="openrouter:anthropic/claude-3.7-sonnet:thinking">Claude 3.7 Sonnet (Thinking)</option>
                    <option value="openrouter:anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="openrouter:anthropic/claude-3-opus">Claude 3 Opus</option>
                    <option value="openrouter:openai/gpt-4o">GPT-4o</option>
                    <option value="openrouter:google/gemini-pro">Gemini Pro</option>
                    <option value="openrouter:meta-llama/llama-3-70b-instruct">Llama 3 70B</option>
                    <option value="custom">Custom model...</option>
                </select>
            </div>
            <div id="custom-model-container" class="form-group" style="display: none;">
                <label for="custom-model" class="form-label">Custom Model Name</label>
                <input id="custom-model" class="form-input" type="text" placeholder="e.g. openrouter:anthropic/claude-3-haiku">
            </div>
            <div class="form-group">
                <label for="temperature" class="form-label">Temperature: <span id="temperature-value">0.7</span></label>
                <input id="temperature" class="form-input" type="range" min="0" max="1" step="0.1" value="0.7">
            </div>
            <div class="form-group">
                <label for="max-tokens" class="form-label">Max Tokens</label>
                <input id="max-tokens" class="form-input" type="number" min="100" max="100000" value="4096">
            </div>
            <div class="form-group">
                <label for="system-prompt" class="form-label">System Prompt</label>
                <textarea id="system-prompt" class="form-textarea" placeholder="Instructions for the AI..."></textarea>
            </div>
            <button id="save-settings-btn" class="save-settings-btn">Save Settings</button>
        </div>
    </div>
    
    <script>
        // Настройка библиотеки marked для Markdown
        // Ждем, пока hljs будет полностью загружен
        window.addEventListener('DOMContentLoaded', () => {
            if (window.hljs) {
                marked.setOptions({
                    renderer: new marked.Renderer(),
                    highlight: function(code, lang) {
                        try {
                            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                            return hljs.highlight(code, { language }).value;
                        } catch (e) {
                            console.error('Error highlighting code:', e);
                            return code; // Возвращаем исходный код без подсветки в случае ошибки
                        }
                    },
                    langPrefix: 'hljs language-',
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    sanitize: false
                });
            } else {
                // Если hljs не загрузился, используем простые опции без подсветки
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    sanitize: false
                });
                console.warn('Highlight.js not loaded, code highlighting disabled');
            }
        });
        
        // Fallback рендеринг кода без highlight.js
        function renderCode(code, language) {
            if (window.hljs) {
                try {
                    const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                    return hljs.highlight(code, { language: validLanguage }).value;
                } catch (e) {
                    console.error('Error in code highlighting:', e);
                    return escapeHtml(code);
                }
            } else {
                return escapeHtml(code);
            }
        }
        
        // Escape HTML для безопасного отображения кода
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Показать индикатор "думающего" LLM
        function showThinkingIndicator() {
            // Проверяем, нет ли уже индикатора
            if (document.getElementById('thinking-indicator')) return;
            
            const indicatorElement = document.createElement('div');
            indicatorElement.id = 'thinking-indicator';
            indicatorElement.className = 'thinking-indicator';
            indicatorElement.innerHTML = `
                <div class="thinking-icon">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <div class="thinking-text">Claude is thinking...</div>
            `;
            chatContainer.appendChild(indicatorElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Скрыть индикатор "думающего" LLM
        function hideThinkingIndicator() {
            const indicatorElement = document.getElementById('thinking-indicator');
            if (indicatorElement) {
                indicatorElement.remove();
            }
        }
        
        // Показать индикатор reasoning (когда модель использует thinking)
        function showReasoningIndicator(messageElement) {
            // Проверяем, использует ли модель thinking
            if (config.model.includes(':thinking')) {
                const reasoningElement = document.createElement('div');
                reasoningElement.className = 'reasoning-indicator';
                reasoningElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="M12 8h.01"></path>
                    </svg>
                    <span>Claude is reasoning carefully</span>
                `;
                
                // Вставляем перед содержимым сообщения
                const contentElement = messageElement.querySelector('.message-content');
                if (contentElement) {
                    messageElement.insertBefore(reasoningElement, contentElement);
                }
            }
        }
        
        // Показать состояние отправки сообщения
        function showSendingState(messageElement) {
            messageElement.classList.add('sending');
            setTimeout(() => {
                messageElement.classList.remove('sending');
            }, 1000);
        }
        
        // Показать состояние получения ответа
        function showReceivingState(messageElement) {
            messageElement.classList.add('receiving');
        }
        
        // Скрыть состояние получения ответа
        function hideReceivingState(messageElement) {
            messageElement.classList.remove('receiving');
        }
        
        // Показать состояние ошибки
        function showErrorState(messageElement, errorMessage) {
            messageElement.classList.add('error');
            const contentElement = messageElement.querySelector('.message-content');
            contentElement.innerHTML = `<p>❌ Error: ${errorMessage}</p>`;
        }
        
        // Configuration object with default settings
        const defaultConfig = {
            model: "openrouter:anthropic/claude-3.7-sonnet:thinking",
            temperature: 0.7,
            maxTokens: 4096,
            systemPrompt: ""
        };
        
        // Current configuration (will be loaded from localStorage if available)
        let config = { ...defaultConfig };
        
        // Chat messages
        let messages = [];
        
        // Controller for stopping generation
        let abortController = null;
        
        // DOM elements
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const contextLimit = document.getElementById('context-limit');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const regenerateBtn = document.getElementById('regenerate-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const downloadBtn = document.getElementById('download-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modelSelect = document.getElementById('model-select');
        const customModelContainer = document.getElementById('custom-model-container');
        const customModel = document.getElementById('custom-model');
        const temperature = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        const maxTokens = document.getElementById('max-tokens');
        const systemPrompt = document.getElementById('system-prompt');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        
        // Load configuration from localStorage
        function loadConfig() {
            const savedConfig = localStorage.getItem('claudeChatConfig');
            if (savedConfig) {
                try {
                    config = { ...defaultConfig, ...JSON.parse(savedConfig) };
                    
                    // Update UI with loaded settings
                    temperature.value = config.temperature;
                    temperatureValue.textContent = config.temperature;
                    maxTokens.value = config.maxTokens;
                    systemPrompt.value = config.systemPrompt || '';
                    
                    // Handle custom model
                    if (modelSelect.querySelector(`option[value="${config.model}"]`)) {
                        modelSelect.value = config.model;
                    } else {
                        modelSelect.value = 'custom';
                        customModel.value = config.model;
                        customModelContainer.style.display = 'block';
                    }
                } catch (e) {
                    console.error('Error loading config:', e);
                    config = { ...defaultConfig };
                }
            }
        }
        
        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('claudeChatConfig', JSON.stringify(config));
        }
        
        // Load messages from localStorage
        function loadMessages() {
            const savedMessages = localStorage.getItem('claudeChatMessages');
            if (savedMessages) {
                try {
                    messages = JSON.parse(savedMessages);
                    renderMessages();
                } catch (e) {
                    console.error('Error loading messages:', e);
                    messages = [];
                }
            }
        }
        
        // Save messages to localStorage
        function saveMessages() {
            localStorage.setItem('claudeChatMessages', JSON.stringify(messages));
        }
        
        // Add a new message to the chat
        function addMessage(role, content, isStreaming = false) {
            const messageId = Date.now().toString();
            messages.push({
                id: messageId,
                role,
                content,
                timestamp: new Date().toISOString()
            });
            
            renderMessage(messages[messages.length - 1], isStreaming);
            saveMessages();
            
            return messageId;
        }
        
        // Update an existing message
        function updateMessage(id, content) {
            const index = messages.findIndex(m => m.id === id);
            if (index !== -1) {
                messages[index].content = content;
                
                const messageElement = document.getElementById(`message-${id}`);
                if (messageElement) {
                    const contentElement = messageElement.querySelector('.message-content');
                    
                    try {
                        // Рендерим содержимое с Markdown
                        contentElement.innerHTML = marked.parse(content);
                        
                        // Добавляем кнопки копирования к блокам кода
                        addCopyButtonsToCodeBlocks(contentElement);
                    } catch (e) {
                        console.error('Error rendering markdown:', e);
                        // Fallback для простого текста
                        contentElement.textContent = content;
                    }
                    
                    // Обновляем счетчик символов
                    const charCountElement = messageElement.querySelector('.char-count');
                    charCountElement.textContent = `${content.length} characters`;
                }
                
                saveMessages();
            }
        }
        
        // Delete a message
        function deleteMessage(id) {
            const index = messages.findIndex(m => m.id === id);
            if (index !== -1) {
                messages.splice(index, 1);
                
                const messageElement = document.getElementById(`message-${id}`);
                if (messageElement) {
                    messageElement.remove();
                }
                
                saveMessages();
            }
        }
        
        // Добавляет кнопки копирования к блокам кода
        function addCopyButtonsToCodeBlocks(element) {
            // Находим все блоки pre>code
            const codeBlocks = element.querySelectorAll('pre > code');
            
            codeBlocks.forEach((codeBlock, index) => {
                // Получаем родительский pre-элемент
                const preBlock = codeBlock.parentNode;
                
                // Проверяем, есть ли уже кнопка копирования
                if (!preBlock.querySelector('.copy-code-btn')) {
                    // Создаем кнопку копирования
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-code-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.setAttribute('aria-label', 'Copy code to clipboard');
                    
                    // Добавляем обработчик события клика
                    copyButton.addEventListener('click', function() {
                        // Получаем текст кода
                        const code = codeBlock.textContent;
                        
                        // Копируем в буфер обмена
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                // Визуальное подтверждение успешного копирования
                                const originalText = this.textContent;
                                this.textContent = 'Copied!';
                                setTimeout(() => {
                                    this.textContent = originalText;
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy code: ', err);
                                this.textContent = 'Error!';
                                setTimeout(() => {
                                    this.textContent = 'Copy';
                                }, 2000);
                            });
                    });
                    
                    // Добавляем кнопку к блоку pre
                    preBlock.appendChild(copyButton);
                }
            });
        }
        
        // Render all messages
        function renderMessages() {
            chatContainer.innerHTML = '';
            messages.forEach(message => {
                renderMessage(message);
            });
        }
        
        // Render a single message
        function renderMessage(message, isStreaming = false) {
            let messageElement = document.getElementById(`message-${message.id}`);
            const isNewMessage = !messageElement;
            
            if (isNewMessage) {
                messageElement = document.createElement('div');
                messageElement.id = `message-${message.id}`;
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : 'bot-message'}`;
                
                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';
                
                const messageSender = document.createElement('div');
                messageSender.className = 'message-sender';
                messageSender.textContent = message.role === 'user' ? 'You' : 'Claude';
                
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn';
                editBtn.textContent = '✏️';
                editBtn.title = 'Edit message';
                editBtn.addEventListener('click', () => {
                    const newContent = prompt('Edit message:', message.content);
                    if (newContent !== null && newContent !== message.content) {
                        updateMessage(message.id, newContent);
                    }
                });
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn';
                copyBtn.textContent = '📋';
                copyBtn.title = 'Copy message';
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message.content);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn';
                deleteBtn.textContent = '🗑️';
                deleteBtn.title = 'Delete message';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this message?')) {
                        deleteMessage(message.id);
                    }
                });
                
                messageActions.appendChild(editBtn);
                messageActions.appendChild(copyBtn);
                messageActions.appendChild(deleteBtn);
                
                messageHeader.appendChild(messageSender);
                messageHeader.appendChild(messageActions);
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                try {
                    // Используем marked для рендеринга Markdown
                    messageContent.innerHTML = marked.parse(message.content);
                } catch (e) {
                    console.error('Error parsing markdown:', e);
                    // Fallback для отображения простого текста
                    messageContent.textContent = message.content;
                }
                
                const charCount = document.createElement('div');
                charCount.className = 'char-count';
                charCount.textContent = `${message.content.length} characters`;
                
                messageElement.appendChild(messageHeader);
                
                // Добавляем индикатор reasoning для сообщений бота с thinking
                if (message.role === 'assistant' && config.model.includes(':thinking')) {
                    showReasoningIndicator(messageElement);
                }
                
                messageElement.appendChild(messageContent);
                messageElement.appendChild(charCount);
                
                chatContainer.appendChild(messageElement);
                
                // Анимация отправки для сообщений пользователя
                if (message.role === 'user') {
                    showSendingState(messageElement);
                }
                
                // Добавляем кнопки копирования к блокам кода
                addCopyButtonsToCodeBlocks(messageContent);
                
            } else if (!isStreaming) {
                // Update existing message
                const contentElement = messageElement.querySelector('.message-content');
                
                try {
                    contentElement.innerHTML = marked.parse(message.content);
                    
                    // Добавляем кнопки копирования к блокам кода
                    addCopyButtonsToCodeBlocks(contentElement);
                } catch (e) {
                    console.error('Error parsing markdown:', e);
                    // Fallback для отображения простого текста
                    contentElement.textContent = message.content;
                }
                
                const charCountElement = messageElement.querySelector('.char-count');
                charCountElement.textContent = `${message.content.length} characters`;
            }
            
            // Scroll to the latest message
            if (isNewMessage) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        // Send message to the LLM
        async function sendMessage() {
            const userInput = messageInput.value.trim();
            if (!userInput) return;
            
            // Add user message to chat
            addMessage('user', userInput);
            
            // Clear input
            messageInput.value = '';
            
            // Prepare context window for API call
            const contextWindow = prepareContextWindow();
            
            // Показываем индикатор думающего LLM
            showThinkingIndicator();
            
            // Add an empty bot message (for streaming)
            const botMessageId = addMessage('assistant', '', true);
            const botMessage = document.getElementById(`message-${botMessageId}`);
            const botMessageContent = botMessage.querySelector('.message-content');
            
            // Показываем, что бот получает сообщение
            showReceivingState(botMessage);
            
            // Enable stop button, disable send and regenerate
            sendBtn.disabled = true;
            stopBtn.disabled = false;
            regenerateBtn.disabled = true;
            
            let fullResponse = '';
            abortController = new AbortController();
            
            try {
                // Build messages array for API
                const apiMessages = [];
                
                // Add system prompt if set
                if (config.systemPrompt) {
                    apiMessages.push({
                        role: 'system',
                        content: config.systemPrompt
                    });
                }
                
                // Add context messages
                contextWindow.forEach(msg => {
                    apiMessages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });
                
                // Скрываем индикатор думающего LLM перед отправкой запроса
                hideThinkingIndicator();
                
                // Call LLM API with streaming
                const response = await puter.ai.chat(
                    apiMessages.length === 0 ? userInput : apiMessages, 
                    {
                        model: config.model,
                        temperature: parseFloat(config.temperature),
                        max_tokens: parseInt(config.maxTokens),
                        stream: true,
                        signal: abortController.signal
                    }
                );
                
                // Process streaming response
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        try {
                            botMessageContent.innerHTML = marked.parse(fullResponse);
                            
                            // Добавляем кнопки копирования к новым блокам кода
                            addCopyButtonsToCodeBlocks(botMessageContent);
                        } catch (e) {
                            console.error('Error parsing markdown during streaming:', e);
                            // Fallback для отображения простого текста
                            botMessageContent.textContent = fullResponse;
                        }
                        
                        botMessage.querySelector('.char-count').textContent = `${fullResponse.length} characters`;
                        botMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                }
                
                // Скрываем анимацию получения ответа
                hideReceivingState(botMessage);
                
                // Update message with full response
                updateMessage(botMessageId, fullResponse);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                    // При отмене оставляем текущий ответ
                    hideReceivingState(botMessage);
                } else {
                    console.error('Error calling LLM:', error);
                    // Показываем ошибку
                    hideReceivingState(botMessage);
                    showErrorState(botMessage, error.message);
                }
            } finally {
                // Скрываем индикатор думающего LLM
                hideThinkingIndicator();
                
                // Reset UI state
                abortController = null;
                sendBtn.disabled = false;
                stopBtn.disabled = true;
                regenerateBtn.disabled = false;
            }
        }
        
        // Prepare the context window based on the limit setting
        function prepareContextWindow() {
            const limit = contextLimit.value.trim();
            
            if (limit === '-' || limit === '') {
                // Return all messages
                return [...messages];
            }
            
            const numericLimit = parseInt(limit);
            if (isNaN(numericLimit) || numericLimit <= 0) {
                return [...messages];
            }
            
            // Return the last N messages
            return messages.slice(-numericLimit);
        }
        
        // Regenerate the last bot response
        async function regenerateLastResponse() {
            // Find the last bot message
            const lastBotMessageIndex = [...messages].reverse().findIndex(m => m.role === 'assistant');
            if (lastBotMessageIndex === -1) return;
            
            const lastBotMessage = messages[messages.length - 1 - lastBotMessageIndex];
            
            // Prepare context up to the last user message
            const contextMessages = messages.slice(0, messages.length - 1 - lastBotMessageIndex);
            
            // Delete last bot message
            deleteMessage(lastBotMessage.id);
            
            // Показываем индикатор думающего LLM
            showThinkingIndicator();
            
            // Disable buttons
            sendBtn.disabled = true;
            regenerateBtn.disabled = true;
            stopBtn.disabled = false;
            
            // Add an empty bot message (for streaming)
            const botMessageId = addMessage('assistant', '', true);
            const botMessage = document.getElementById(`message-${botMessageId}`);
            const botMessageContent = botMessage.querySelector('.message-content');
            
            // Показываем, что бот получает сообщение
            showReceivingState(botMessage);
            
            let fullResponse = '';
            abortController = new AbortController();
            
            try {
                // Build messages array for API
                const apiMessages = [];
                
                // Add system prompt if set
                if (config.systemPrompt) {
                    apiMessages.push({
                        role: 'system',
                        content: config.systemPrompt
                    });
                }
                
                // Add context messages
                contextMessages.forEach(msg => {
                    apiMessages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });
                
                // Скрываем индикатор думающего LLM перед отправкой запроса
                hideThinkingIndicator();
                
                // Call LLM API with streaming
                const response = await puter.ai.chat(
                    apiMessages, 
                    {
                        model: config.model,
                        temperature: parseFloat(config.temperature),
                        max_tokens: parseInt(config.maxTokens),
                        stream: true,
                        signal: abortController.signal
                    }
                );
                
                // Process streaming response
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        try {
                            botMessageContent.innerHTML = marked.parse(fullResponse);
                            
                            // Добавляем кнопки копирования к блокам кода
                            addCopyButtonsToCodeBlocks(botMessageContent);
                        } catch (e) {
                            console.error('Error parsing markdown during streaming:', e);
                            // Fallback для отображения простого текста
                            botMessageContent.textContent = fullResponse;
                        }
                        
                        botMessage.querySelector('.char-count').textContent = `${fullResponse.length} characters`;
                        botMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                }
                
                // Скрываем анимацию получения ответа
                hideReceivingState(botMessage);
                
                // Update message with full response
                updateMessage(botMessageId, fullResponse);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                    // При отмене оставляем текущий ответ
                    hideReceivingState(botMessage);
                } else {
                    console.error('Error calling LLM:', error);
                    // Показываем ошибку
                    hideReceivingState(botMessage);
                    showErrorState(botMessage, error.message);
                }
            } finally {
                // Скрываем индикатор думающего LLM
                hideThinkingIndicator();
                
                // Reset UI state
                abortController = null;
                sendBtn.disabled = false;
                stopBtn.disabled = true;
                regenerateBtn.disabled = false;
            }
        }
        
        // Stop generation
        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
                stopBtn.disabled = true;
                sendBtn.disabled = false;
                regenerateBtn.disabled = false;
                
                // Скрываем все индикаторы
                hideThinkingIndicator();
                
                const lastBotMessage = document.querySelector('.bot-message.receiving');
                if (lastBotMessage) {
                    hideReceivingState(lastBotMessage);
                }
            }
        }
        
        // Download AI responses as HTML
        function downloadAIResponses() {
            // Filter only assistant messages
            const aiResponses = messages.filter(msg => msg.role === 'assistant');
            
            if (aiResponses.length === 0) {
                alert('No AI responses to download.');
                return;
            }
            
            // Create HTML content
            let htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Responses</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .response {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        pre {
            background-color: #f5f7f9;
            border-radius: 6px;
            padding: 12px;
            overflow: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        p {
            margin: 0.75em 0;
        }
        ul, ol {
            padding-left: 2em;
            margin: 0.75em 0;
        }
        blockquote {
            border-left: 3px solid #dfe2e5;
            margin: 0.75em 0;
            padding: 0 0 0 1em;
            color: #666;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 0.375em 0.75em;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>AI Responses</h1>`;
            
            // Add each response
            aiResponses.forEach((response, index) => {
                try {
                    htmlContent += `
    <div class="response">
        ${marked.parse(response.content)}
    </div>`;
                } catch (e) {
                    // Fallback для обычного текста при ошибке
                    htmlContent += `
    <div class="response">
        <p>${response.content}</p>
    </div>`;
                }
            });
            
            htmlContent += `
</body>
</html>`;
            
            // Create download link
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-responses-${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
        
        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        stopBtn.addEventListener('click', stopGeneration);
        
        regenerateBtn.addEventListener('click', regenerateLastResponse);
        
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });
        
        closeModalBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        modelSelect.addEventListener('change', () => {
            if (modelSelect.value === 'custom') {
                customModelContainer.style.display = 'block';
            } else {
                customModelContainer.style.display = 'none';
            }
        });
        
        temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
        });
        
        saveSettingsBtn.addEventListener('click', () => {
            // Get values from form
            config.temperature = parseFloat(temperature.value);
            config.maxTokens = parseInt(maxTokens.value);
            config.systemPrompt = systemPrompt.value.trim();
            
            // Handle model selection
            if (modelSelect.value === 'custom') {
                config.model = customModel.value.trim();
            } else {
                config.model = modelSelect.value;
            }
            
            // Save config and close modal
            saveConfig();
            settingsModal.style.display = 'none';
        });
        
        downloadBtn.addEventListener('click', downloadAIResponses);
        
        // Click outside modal to close
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        
        // Handle ESC key to close modal
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && settingsModal.style.display === 'flex') {
                settingsModal.style.display = 'none';
            }
        });
        
        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            // Загружаем настройки и историю чата
            loadConfig();
            loadMessages();
            
            // If there are no messages, add a welcome message
            if (messages.length === 0) {
                addMessage('assistant', "# Hello! I'm Claude.\n\nI can help you with various tasks. Here are some of my capabilities:\n\n- Answering questions and providing information\n- Writing and editing content\n- Analyzing data and solving problems\n- Programming assistance and code generation\n- Creative writing and brainstorming\n\nHow can I assist you today?");
            }
        });
    </script>
</body>
</html>
